version: '3'

vars:
  NVM_VERSION: "0.40.3"

tasks:
  default:
    - task --list --taskfile languages/node.yaml

  install-nvm:linux:
    internal: true
    platforms: [linux]
    cmds:
      - |
        if [ -x "$HOME/.nvm/nvm.sh" ]; then
          echo "nvm is already installed."
        else
          curl -o- "https://raw.githubusercontent.com/nvm-sh/nvm/v{{ .NVM_VERSION }}/install.sh" | bash
          echo "nvm has been installed successfully."
        fi
    status:
      - test -d "$HOME/scoop/apps/{{ .APP_NAME }}/current"

  install:linux:
    internal: true
    platforms: [linux]
    cmds:
      - task: install-nvm
      - |
        NVM_CLI="nvm"
        if ! command -v nvm >/dev/null 2>&1; then
          if [ -f "$HOME\scoop\apps\nvm\current\nvm.exe" ]; then
            PATH="$HOME\scoop\apps\nvm\current\:$HOME\scoop\apps\nvm\current\:$PATH"
            NVM_HOME="$HOME\scoop\apps\nvm\current"
            NVM_SYMLINK="$HOME\scoop\apps\nvm\current\nodejs\nodejs"
            NVM_CLI="$HOME\scoop\apps\nvm\current\nvm.exe"
          else
            echo "❌ ERROR: nvm is not installed"
            echo "Please install nvm first."
            exit 1
          fi
        fi
        if [ -z $NVM_HOME ]; then
            echo "❌ ERROR: NVM_HOME is not set"
            exit 1
        fi
        if [ -z $NVM_SYMLINK ]; then
            echo "❌ ERROR: NVM_SYMLINK is not set"
            exit 1
        fi
        NVM_HOME=$NVM_HOME NVM_SYMLINK=$NVM_SYMLINK $NVM_CLI install lts
        NVM_HOME=$NVM_HOME NVM_SYMLINK=$NVM_SYMLINK $NVM_CLI use lts

  install-nvm:windows:
    internal: true
    platforms: [windows]
    vars:
      APP_NAME: nvm
    cmds:
      - |
        if [ ! -d "$HOME/scoop/apps/{{ .APP_NAME }}/current" ]; then
          scoop install {{ .APP_NAME }}
          echo "{{ .APP_NAME }} has been installed successfully."
        fi

  install:windows:
    internal: true
    platforms: [windows] 
    cmds:
      - task: install-nvm:windows
      - |
        if ! command -v nvm >/dev/null 2>&1; then
          echo "❌ ERROR: nvm is not installed"
          echo "Please install nvm first."
          exit 1
        fi
      - |
          nvm install --lts
          nvm use --lts
          nvm alias default node

  install:
    desc: "[NODE] ✨ Install node"
    cmds:
      - task: install:linux
        platforms: [linux]
      - task: install:windows
        platforms: [windows]
