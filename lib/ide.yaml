version: '3'

includes:
  cursor-rules: 
    taskfile: ide/cursor-rules.yaml
    flatten: true

vars:
  IDE_EXTENSIONS_base:
    - Catppuccin.catppuccin-vsc
    - Catppuccin.catppuccin-vsc-icons
    - svelte.svelte-vscode
    - tamasfe.even-better-toml
    - golang.Go
    - rust-lang.rust-analyzer
    - oderwat.indent-rainbow
    - humao.rest-client
    - esbenp.prettier-vscode
    - EditorConfig.EditorConfig
    - redhat.vscode-yaml
  IDE_EXTENSIONS_remote:
    - ms-vscode-remote.remote-containers
    - ms-vscode-remote.remote-wsl
    - ms-vscode-remote.remote-ssh
  IDE_EXTENSIONS_vscode:
    - tejasvi.rainbow-brackets-2
  IDE_EXTENSIONS_cursor:
    - CoenraadS.bracket-pair-colorizer-2
  IDE_EXTENSIONS_vscodium:
    - sourcegraph.amp


tasks:
  find-cli:
    silent: true
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        try_path() {
          p="$1"
          if command -v "$p" >/dev/null 2>&1; then
            echo "$p"
            exit 0
          fi
          if [ -f "$p" ]; then
            echo "$p"
            exit 0
          fi
        }

        case "{{ .IDE }}" in
          vscode)
            try_path "$HOME/scoop/apps/vscode/current/bin/code.cmd"
            try_path "$LOCALAPPDATA/Programs/Microsoft VS Code/bin/code.cmd"
            try_path "$PROGRAMFILES/Microsoft VS Code/bin/code.cmd"
            try_path "code"
            try_path "/usr/bin/code"
            try_path "/usr/local/bin/code"
            ;;
          cursor)
            try_path "$LOCALAPPDATA/Programs/cursor/resources/app/bin/cursor.cmd"
            try_path "$PROGRAMFILES/Cursor/resources/app/bin/cursor.cmd"
            try_path "$LOCALAPPDATA/cursor/cursor.exe"
            try_path "$HOME/scoop/apps/cursor/current/cursor.exe"
            try_path "$HOME/scoop/shims/cursor.cmd"
            try_path "cursor"
            try_path "/usr/bin/cursor"
            try_path "/usr/local/bin/cursor"
            try_path "/opt/cursor/cursor"
            ;;
          vscodium)
            try_path "$HOME/scoop/apps/vscodium/current/bin/codium.cmd"
            try_path "$HOME/scoop/apps/vscodium-portable/current/bin/codium.cmd"
            try_path "$HOME/scoop/shims/codium.cmd"
            try_path "$LOCALAPPDATA/Programs/VSCodium/bin/codium.cmd"
            try_path "$PROGRAMFILES/VSCodium/bin/codium.cmd"
            try_path "codium"
            try_path "/usr/bin/codium"
            try_path "/usr/local/bin/codium"
            try_path "/opt/vscodium/bin/codium"
            ;;
        esac

        echo "ERROR: Could not find {{ .IDE }} CLI in any known location" >&2
        exit 1

  find-settings-path:
    silent: true
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        try_settings() {
          p="$1"
          if [ -f "$p" ]; then
            echo "$p"
            exit 0
          fi
          dir="${p%/*}"
          if [ -d "$dir" ]; then
            echo "$p"
            exit 0
          fi
        }

        case "{{ .IDE }}" in
          vscode)
            try_settings "$HOME/scoop/persist/vscode/data/user-data/User/settings.json"
            try_settings "$APPDATA/Code/User/settings.json"
            try_settings "$HOME/.config/Code/User/settings.json"
            FALLBACK="$APPDATA/Code/User/settings.json"
            ;;
          cursor)
            try_settings "$HOME/scoop/persist/cursor/User/settings.json"
            try_settings "$APPDATA/Cursor/User/settings.json"
            try_settings "$HOME/.config/Cursor/User/settings.json"
            FALLBACK="$APPDATA/Cursor/User/settings.json"
            ;;
          vscodium)
            try_settings "$HOME/scoop/persist/vscodium/data/user-data/User/settings.json"
            try_settings "$HOME/scoop/persist/vscodium-portable/data/user-data/User/settings.json"
            try_settings "$APPDATA/VSCodium/User/settings.json"
            try_settings "$HOME/.config/VSCodium/User/settings.json"
            FALLBACK="$APPDATA/VSCodium/User/settings.json"
            ;;
        esac

        echo "$FALLBACK"

  install-extensions:
    silent: true
    requires:
      vars: [IDE, IDE_EXTENSIONS]
    env:
      CLI_BINARY:
        sh: task ide:find-cli IDE={{ .IDE }}
    cmds:
      - |
        if [ -z "$CLI_BINARY" ]; then
          echo "‚ùå ERROR: Could not find {{ .IDE }} CLI"
          exit 1
        fi
        echo "‚úÖ Found {{ .IDE }} CLI: $CLI_BINARY"
        echo "üì¶ Installing extensions..."
        install_extensions=()
        {{range .IDE_EXTENSIONS | join "\n" | split "\n"}}
          {{ $extensions := split " " . }}
          {{range $extensions}}
          install_extensions+=("--install-extension {{.}}")
          echo "  ‚Üí Installing {{.}}"
          {{end}}
        {{end}}

        "$CLI_BINARY" ${install_extensions[@]} 2>/dev/null || true
        echo "‚úÖ Extensions installed"

  copy-settings:
    silent: true
    deps: [":tools:gum:install"]
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        SETTINGS_PATH=$(task ide:find-settings-path IDE={{ .IDE }})
        echo "üìÅ Target settings path: $SETTINGS_PATH"

        write_settings=true
        if [ -f "$SETTINGS_PATH" ]; then
          if [ "{{ .UNATTENDED }}" = "true" ]; then
            echo "‚ö†Ô∏è  Unattended mode: overwriting existing config"
          else
            if ! gum confirm "Settings file exists at $SETTINGS_PATH. Overwrite?"; then
              write_settings=false
              echo "‚è≠Ô∏è  Skipping settings copy"
            fi
          fi
        fi

        if $write_settings; then
          mkdir -p "$(dirname "$SETTINGS_PATH")"
          cp dotfiles/vscode/settings.json "$SETTINGS_PATH"
          echo "‚úÖ Settings copied to $SETTINGS_PATH"
        fi

  configure:vscode:
    cmds:
      - task: install-extensions
        vars:
          IDE: vscode
          IDE_EXTENSIONS:
            - '{{ .IDE_EXTENSIONS_base | join " "}}'
            - '{{ .IDE_EXTENSIONS_remote | join " "}}'
            - '{{ .IDE_EXTENSIONS_vscode | join " "}}'
      - task: copy-settings
        vars:
          IDE: vscode

  configure:cursor:
    cmds:
      - task: install-extensions
        vars:
          IDE: cursor
          IDE_EXTENSIONS:
            - '{{ .IDE_EXTENSIONS_base | join " "}}'
            - '{{ .IDE_EXTENSIONS_remote | join " "}}'
            - '{{ .IDE_EXTENSIONS_cursor | join " "}}'
      - task: copy-settings
        vars:
          IDE: cursor

  configure:vscodium:
    cmds:
      - task: install-extensions
        vars:
          IDE: vscodium
          IDE_EXTENSIONS:
            - '{{ .IDE_EXTENSIONS_base | join " "}}'
            - '{{ .IDE_EXTENSIONS_vscodium | join " "}}'
      - task: copy-settings
        vars:
          IDE: vscodium

  configure:
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - task: configure:{{ .IDE }}
