version: '3'

includes:
  cursor-rules: 
    dir: ..
    taskfile: cursor-rules.yaml
    flatten: true

vars:
  IDE_EXTENSIONS_vscode:
    - ms-vscode-remote.remote-containers
    - ms-vscode-remote.remote-wsl
    - ms-vscode-remote.remote-ssh
    - Catppuccin.catppuccin-vsc
    - Catppuccin.catppuccin-vsc-icons
    - svelte.svelte-vscode
    - tamasfe.even-better-toml
    - golang.Go
    - rust-lang.rust-analyzer
    - oderwat.indent-rainbow
    - tejasvi.rainbow-brackets-2
    - humao.rest-client
    - esbenp.prettier-vscode
    - EditorConfig.EditorConfig
    - redhat.vscode-yaml
    - Anthropic.claude-code
    - openai.chatgpt
  IDE_EXTENSIONS_cursor:
    - ms-vscode-remote.remote-containers
    - ms-vscode-remote.remote-wsl
    - ms-vscode-remote.remote-ssh
    - Catppuccin.catppuccin-vsc
    - Catppuccin.catppuccin-vsc-icons
    - svelte.svelte-vscode
    - tamasfe.even-better-toml
    - golang.Go
    - rust-lang.rust-analyzer
    - oderwat.indent-rainbow
    - humao.rest-client
    - esbenp.prettier-vscode
    - EditorConfig.EditorConfig
    - redhat.vscode-yaml
    - CoenraadS.bracket-pair-colorizer-2
  IDE_EXTENSIONS_vscodium:
    - Catppuccin.catppuccin-vsc
    - Catppuccin.catppuccin-vsc-icons
    - svelte.svelte-vscode
    - tamasfe.even-better-toml
    - golang.Go
    - rust-lang.rust-analyzer
    - oderwat.indent-rainbow
    - humao.rest-client
    - esbenp.prettier-vscode
    - EditorConfig.EditorConfig
    - redhat.vscode-yaml
    - Anthropic.claude-code
    - openai.chatgpt
    - jeanp413.open-remote-wsl
    - jeanp413.open-remote-ssh
  IDE_EXTENSIONS_vscodium_remote:
    - ms-azuretools.vscode-bicep

tasks:
  default:
    - task --list --taskfile taskfiles/ide.yaml

  fetch-vsix:
    requires:
      vars:
        - EXTENSION_ID
        - DESTINATION_PATH
    vars:
      PUBLISHER: '{{ index (splitList "." .EXTENSION_ID) 0 }}'
      PACKAGE: '{{ index (splitList "." .EXTENSION_ID) 1 }}'
      VSIX_URL: 'https://{{ .PUBLISHER }}.gallery.vsassets.io/_apis/public/gallery/publisher/{{ .PUBLISHER }}/extension/{{ .PACKAGE }}/latest/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage'
      VSIX_FILE: '{{ .EXTENSION_ID | replace "." "_" }}.vsix'
      SPINNERS: [ line, dot, minidot, jump, points, hamburger ]
      SPINNER: "{{ index .SPINNERS (randInt 0 (len .SPINNERS)) }}"
      WITTY_PHRASES:
      - "You forget a thousand things every day. This isn't one of them. Probably."
      - "Connecting to AGI (please hold your existential dread)"
      - "Summoning silicon spirits‚Ä¶"
      - "Adjusting neural hamsters‚Ä¶"
      - "Reticulating splines (again)"
      - "Asking electrons nicely"
      - "Consulting the oracle (it runs on JavaScript)"
      - "Arranging bits into meaningful lies"
      - "Convincing math to think"
      - "Loading intelligence‚Ä¶ no refunds"
      - "Initiating polite conversation with a machine"
      - "Teaching rocks to reason"
      - "Aligning vibes and vectors"
      - "Shaking hands with probability"
      - "Applying duct tape to reality"
      - "Spinning up artificial opinions"
      - "Coaxing thoughts from sand"
      - "Engaging speculative cognition"
      - "Crossing fingers, flipping bits"
      - "Borrowing intelligence from the future"
      - "Negotiating with entropy"
      - "Putting the 'artificial' in artificial intelligence"
      - "Loading answers, questions sold separately"
      - "Briefly confusing causality"
      - "Starting thought experiment #42"
      - "Inviting chaos, but politely"
      - "Computing‚Ä¶ please blame math"
      - "Turning coffee into logic"
      - "Standing on the shoulders of very small transistors"
      - "Searching for meaning in a pile of floats"
      - "Preparing vaguely helpful insights"
      WITTY_PHRASE: "{{ index .WITTY_PHRASES (randInt 0 (len .WITTY_PHRASES)) }}"
      GUM:
        sh: 'command -v gum || true'
    cmds:
      - |
        {{- if .CLI_VERBOSE }}
        echo "Fetching '{{ .VSIX_URL }}' to {{ .DESTINATION_PATH }}/{{ .VSIX_FILE }}"
        {{- end }}
        {{ if .GUM }}gum spin --spinner="{{ .SPINNER }}" --show-error --show-output --title "{{ .WITTY_PHRASE }}" -- {{ end }}curl -sSL '{{ .VSIX_URL }}' -o '{{ .DESTINATION_PATH }}/{{ .VSIX_FILE }}'

  find-cli:
    desc: "[IDE] üîç Find CLI executable for an IDE (vscode, cursor, vscodium)"
    silent: true
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        try_path() {
          p="$1"
          if command -v "$p" >/dev/null 2>&1; then
            echo "$p"
            exit 0
          fi
          if [ -f "$p" ]; then
            echo "$p"
            exit 0
          fi
        }

        case "{{ .IDE }}" in
          vscode)
            try_path "code"
            try_path "$HOME/scoop/apps/vscode/current/bin/code.cmd"
            try_path "$LOCALAPPDATA/Programs/Microsoft VS Code/bin/code.cmd"
            try_path "$PROGRAMFILES/Microsoft VS Code/bin/code.cmd"
            try_path "/usr/bin/code"
            try_path "/usr/local/bin/code"
            ;;
          cursor)
            try_path "cursor"
            try_path "$HOME/scoop/apps/cursor/current/cursor.exe"
            try_path "$HOME/scoop/shims/cursor.cmd"
            try_path "$LOCALAPPDATA/Programs/cursor/resources/app/bin/cursor.cmd"
            try_path "$LOCALAPPDATA/cursor/cursor.exe"
            try_path "$PROGRAMFILES/Cursor/resources/app/bin/cursor.cmd"
            try_path "/usr/bin/cursor"
            try_path "/usr/local/bin/cursor"
            try_path "/opt/cursor/cursor"
            ;;
          vscodium)
            try_path "codium"
            try_path "$HOME/scoop/apps/vscodium/current/bin/codium.cmd"
            try_path "$HOME/scoop/apps/vscodium-portable/current/bin/codium.cmd"
            try_path "$HOME/scoop/shims/codium.cmd"
            try_path "$LOCALAPPDATA/Programs/VSCodium/bin/codium.cmd"
            try_path "$PROGRAMFILES/VSCodium/bin/codium.cmd"
            try_path "/usr/bin/codium"
            try_path "/usr/local/bin/codium"
            try_path "/opt/vscodium/bin/codium"
            ;;
        esac

        echo "ERROR: Could not find {{ .IDE }} CLI in any known location" >&2
        exit 1

  find-settings-path:
    desc: "[IDE] üîç Find settings.json path for an IDE"
    silent: true
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        try_settings() {
          p="$1"
          if [ -f "$p" ]; then
            echo "$p"
            exit 0
          fi
          dir="${p%/*}"
          if [ -d "$dir" ]; then
            echo "$p"
            exit 0
          fi
        }

        case "{{ .IDE }}" in
          vscode)
            try_settings "$HOME/scoop/persist/vscode/data/user-data/User/settings.json"
            try_settings "$APPDATA/Code/User/settings.json"
            try_settings "$HOME/.config/Code/User/settings.json"
            FALLBACK="$APPDATA/Code/User/settings.json"
            ;;
          cursor)
            try_settings "$HOME/scoop/persist/cursor/User/settings.json"
            try_settings "$APPDATA/Cursor/User/settings.json"
            try_settings "$HOME/.config/Cursor/User/settings.json"
            FALLBACK="$APPDATA/Cursor/User/settings.json"
            ;;
          vscodium)
            try_settings "$HOME/scoop/persist/vscodium/data/user-data/User/settings.json"
            try_settings "$HOME/scoop/persist/vscodium-portable/data/user-data/User/settings.json"
            try_settings "$APPDATA/VSCodium/User/settings.json"
            try_settings "$HOME/.config/VSCodium/User/settings.json"
            FALLBACK="$APPDATA/VSCodium/User/settings.json"
            ;;
        esac

        echo "$FALLBACK"

  install-extensions:
    desc: "[IDE] üì¶ Install extensions for an IDE"
    silent: true
    requires:
      vars: [IDE, IDE_EXTENSIONS]
      SPINNERS: [ line, dot, minidot, jump, points, hamburger ]
      SPINNER: "{{ index .SPINNERS (randInt 0 (len .SPINNERS)) }}"
      WITTY_PHRASES:
      - "You forget a thousand things every day. This isn't one of them. Probably."
      - "Connecting to AGI (please hold your existential dread)"
      - "Summoning silicon spirits‚Ä¶"
      - "Adjusting neural hamsters‚Ä¶"
      - "Reticulating splines (again)"
      - "Asking electrons nicely"
      - "Consulting the oracle (it runs on JavaScript)"
      - "Arranging bits into meaningful lies"
      - "Convincing math to think"
      - "Loading intelligence‚Ä¶ no refunds"
      - "Initiating polite conversation with a machine"
      - "Teaching rocks to reason"
      - "Aligning vibes and vectors"
      - "Shaking hands with probability"
      - "Applying duct tape to reality"
      - "Spinning up artificial opinions"
      - "Coaxing thoughts from sand"
      - "Engaging speculative cognition"
      - "Crossing fingers, flipping bits"
      - "Borrowing intelligence from the future"
      - "Negotiating with entropy"
      - "Putting the 'artificial' in artificial intelligence"
      - "Loading answers, questions sold separately"
      - "Briefly confusing causality"
      - "Starting thought experiment #42"
      - "Inviting chaos, but politely"
      - "Computing‚Ä¶ please blame math"
      - "Turning coffee into logic"
      - "Standing on the shoulders of very small transistors"
      - "Searching for meaning in a pile of floats"
      - "Preparing vaguely helpful insights"
      WITTY_PHRASE: "{{ index .WITTY_PHRASES (randInt 0 (len .WITTY_PHRASES)) }}"
      GUM:
        sh: 'command -v gum || true'
    cmds:
      - |
        CLI_BINARY=$(task ide:find-cli IDE={{ .IDE }} 2>/dev/null)
        if [ $? -ne 0 ] || [ -z "$CLI_BINARY" ]; then
          echo "‚ùå ERROR: Could not find {{ .IDE }} CLI"
          task ide:find-cli IDE={{ .IDE }}
          exit 1
        fi
        echo "‚úÖ Found {{ .IDE }} CLI: $CLI_BINARY"
        echo "üì¶ Installing extensions..."
        {{- range .IDE_EXTENSIONS }}
        echo "  ‚Üí Installing {{.}}"
        {{ if $.GUM }}gum spin --spinner="{{ $.SPINNER }}" --show-error --show-output --title "{{ $.WITTY_PHRASE }}" -- {{ end }}"$CLI_BINARY" --install-extension "{{.}}"{{ if $.FORCE }} --force{{ end }} 2>/dev/null || true
        {{- end }}
        {{- if .REMOTE_EXTENSIONS }}
        echo "üì¶ Installing remote .vsix extensions..."
        {{- range .REMOTE_EXTENSIONS }}
        echo "  ‚Üí Fetching {{ . }}"
        task ide:fetch-vsix EXTENSION_ID='{{ . }}' DESTINATION_PATH='{{ .USER_WORKING_DIR }}'
        echo "  ‚Üí Installing {{ . }}"
        VSIX_FILE='{{ .USER_WORKING_DIR }}/{{ . | replace "." "_" }}.vsix'
        if [ -f "${VSIX_FILE}" ]; then
          {{ if $.GUM }}gum spin --spinner="{{ $.SPINNER }}" --show-error --show-output --title "{{ $.WITTY_PHRASE }}" -- {{ end }}"$CLI_BINARY" --install-extension "${VSIX_FILE}"{{ if $.FORCE }} --force{{ end }} 2>/dev/null || true
          rm "${VSIX_FILE}"
        else
          {{ .gum_error }} "ERROR: File '${VSIX_FILE}' not found."
        fi
        {{- end }}
        {{- end }}
        echo "‚úÖ Extensions installed"

  copy-settings:
    desc: "[IDE] ‚öôÔ∏è Copy settings.json to an IDE"
    silent: true
    deps: [":tools:gum:install"]
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - |
        SETTINGS_PATH=$(task ide:find-settings-path IDE={{ .IDE }})
        echo "üìÅ Target settings path: $SETTINGS_PATH"

        write_settings=true
        if [ -f "$SETTINGS_PATH" ]; then
          if [ "{{ .UNATTENDED }}" = "true" ]; then
            echo "‚ö†Ô∏è  Unattended mode: overwriting existing config"
          else
            if ! gum confirm "Settings file exists at $SETTINGS_PATH. Overwrite?"; then
              write_settings=false
              echo "‚è≠Ô∏è  Skipping settings copy"
            fi
          fi
        fi

        if $write_settings; then
          mkdir -p "$(dirname "$SETTINGS_PATH")"
          cp dotfiles/vscode/settings.json "$SETTINGS_PATH"
          echo "‚úÖ Settings copied to $SETTINGS_PATH"
        fi

  configure:vscode:
    desc: "[VSCODE] ‚öôÔ∏è Configure VS Code (install extensions + copy settings)"
    cmds:
      - task: install-extensions
        vars:
          IDE: vscode
          IDE_EXTENSIONS:
            ref: .IDE_EXTENSIONS_vscode
      - task: copy-settings
        vars:
          IDE: vscode

  configure:cursor:
    desc: "[CURSOR] ‚öôÔ∏è Configure Cursor (install extensions + copy settings)"
    cmds:
      - task: install-extensions
        vars:
          IDE: cursor
          IDE_EXTENSIONS:
            ref: .IDE_EXTENSIONS_cursor
      - task: copy-settings
        vars:
          IDE: cursor

  configure:vscodium:
    desc: "[VSCODIUM] ‚öôÔ∏è Configure VSCodium (install extensions + copy settings)"
    cmds:
      - task: install-extensions
        vars:
          IDE: vscodium
          IDE_EXTENSIONS:
            ref: .IDE_EXTENSIONS_vscodium
      - task: copy-settings
        vars:
          IDE: vscodium

  configure:
    desc: "[IDE] ‚öôÔ∏è Configure an IDE (vscode, cursor, or vscodium)"
    requires:
      vars:
        - name: IDE
          enum: [vscode, cursor, vscodium]
    cmds:
      - task: configure:{{ .IDE }}
