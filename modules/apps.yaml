version: '3'

vars:
  APPS_ROOT_DIR: '{{ .ROOT_DIR }}/apps'

tasks:
  default:
    desc: "Default 'apps' action without any arguments"
    cmds:
      - task: help

  help:
    desc: "Show help for 'apps' sub-command"
    aliases: ['list', 'ls']
    vars:
      FILES:
        sh: task -t "{{ .ROOT_DIR }}/lib.yaml" modules:find-files PATH='{{ .APPS_ROOT_DIR }}' NAME='*.yaml' --silent
    cmds:
    - |
      {{ if eq .FILES "" }}
        echo "No apps found."
      {{ else }}
        echo "Apps available:"
        echo ""
        task -t "{{ .ROOT_DIR }}/lib.yaml" modules:pretty-print-files FILES='{{ .FILES }}' --silent
      {{ end }}
      echo ""
      echo "Usage: omt apps:<name>:[action] -- [options]"
      echo ""
      echo "See 'omt apps:<name>:help' for more information."

  '*:help':
    desc: "Show help for app '*'"
    vars:
      NAME: '{{ index .MATCH 0 }}'
    cmds:
    - |
      task -t "{{ .APPS_ROOT_DIR }}/{{ .NAME }}.yaml" app:help --silent

  '*:*':
    desc: "Run action for app"
    vars:
      NAME: '{{ index .MATCH 0 }}'
      ACTION: '{{ index .MATCH 1 }}'
    cmds:
    - |
      task -t "{{ .APPS_ROOT_DIR }}/{{ .NAME }}.yaml" {{ .ACTION }} --silent{{ if .CLI_VERBOSE }} --verbose{{ end }}
