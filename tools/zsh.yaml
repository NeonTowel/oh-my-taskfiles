version: '3'

tasks:
  install:
    desc: "[ZSH] ‚ú® Install zsh shell"
    cmds:
      - task: install:linux
        platforms: [linux]
      - task: install:darwin
        platforms: [darwin]

  install:linux:
    internal: true
    cmds:
      - task: ::linux-pkg:install
        vars:
          PACKAGE: zsh

  install:darwin:
    internal: true
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          brew install zsh
        else
          echo "Homebrew not found. Please install Homebrew first or install zsh manually."
          exit 1
        fi

  omz:install:
    desc: "[ZSH] ‚ú® Install Oh My Zsh"
    cmds:
      - |
        if [ -d "$HOME/.oh-my-zsh" ]; then
          echo "Oh My Zsh is already installed."
        else
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
          echo "Oh My Zsh has been installed successfully."
        fi

  set-default:
    desc: "[ZSH] ‚öôÔ∏è Set zsh as default shell"
    cmds:
      - |
        zsh_path=$(command -v zsh)
        if [ "$SHELL" != "$zsh_path" ]; then
          echo "Setting zsh as default shell..."
          sudo chsh -s "$zsh_path" $(whoami)
          echo "Zsh is now your default shell. Please log out and log back in for changes to take effect."
        else
          echo "Zsh is already your default shell."
        fi

  install-zshrc:linux:
    internal: true
    cmds:
      - |
        src="$HOME/.omt/dotfiles/zshrc_linux"
        dest="$HOME/.zshrc"
        if [ -f "$src" ]; then
          echo "Installing .zshrc from $src"
          cp "$src" "$dest"
          echo ".zshrc installed successfully."
        else
          echo "Source file $src does not exist. Skipping .zshrc installation."
        fi
  
  install-zshrc:
    desc: "[ZSH] ‚öôÔ∏è Install .zshrc"
    cmds:
      - task: install-zshrc:linux
        platforms: [linux]

  setup:
    desc: "[ZSH] ‚ú® Install zsh, Oh My Zsh and set as default shell"
    cmds:
      - task: install
      - task: omz:install
      - task: set-default
      - task: install-zshrc:{{OS}}

  uninstall:
    desc: "[ZSH] üóëÔ∏è  Uninstall zsh (shell only, not Oh My Zsh)"
    cmds:
      - task: uninstall:linux
        platforms: [linux]
      - task: uninstall:darwin
        platforms: [darwin]

  update:
    desc: "[ZSH] üîÑ Update zsh to latest version"
    cmds:
      - task: update:linux
        platforms: [linux]
      - task: update:darwin
        platforms: [darwin]

  verify:
    desc: "[ZSH] ‚úÖ Verify zsh installation"
    cmds:
      - |
        if ! command -v zsh >/dev/null 2>&1; then
          task :messaging:error MESSAGE="zsh not found in PATH"
          exit 1
        fi
        {{ .gum_ok }} "‚úÖ zsh found: $(command -v zsh)"
        version=$(zsh --version 2>&1 || echo "unknown")
        {{ .gum_info }} "üìã Version: $version"
        if [ -d "$HOME/.oh-my-zsh" ]; then
          {{ .gum_ok }} "‚úÖ Oh My Zsh is installed"
        else
          {{ .gum_info }} "‚ÑπÔ∏è  Oh My Zsh is not installed"
        fi
        zsh_path=$(command -v zsh)
        if [ "$SHELL" = "$zsh_path" ]; then
          {{ .gum_ok }} "‚úÖ zsh is the default shell"
        else
          {{ .gum_info }} "‚ÑπÔ∏è  zsh is not the default shell (current: $SHELL)"
        fi

  uninstall:linux:
    internal: true
    platforms: [linux]
    cmds:
      - |
        if command -v apt-get >/dev/null 2>&1; then
          sudo apt-get remove -y zsh
        elif command -v dnf >/dev/null 2>&1; then
          sudo dnf remove -y zsh
        elif command -v yum >/dev/null 2>&1; then
          sudo yum remove -y zsh
        elif command -v pacman >/dev/null 2>&1; then
          sudo pacman -R --noconfirm zsh
        else
          echo "‚ùå Unsupported package manager"
          exit 1
        fi
      - task: :messaging:success
        vars:
          MESSAGE: "zsh uninstalled successfully"

  uninstall:darwin:
    internal: true
    platforms: [darwin]
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          brew uninstall zsh
        else
          echo "‚ùå Homebrew not found"
          exit 1
        fi
      - task: :messaging:success
        vars:
          MESSAGE: "zsh uninstalled successfully"

  update:linux:
    internal: true
    platforms: [linux]
    cmds:
      - |
        if command -v apt-get >/dev/null 2>&1; then
          sudo apt-get update && sudo apt-get upgrade -y zsh
        elif command -v dnf >/dev/null 2>&1; then
          sudo dnf upgrade -y zsh
        elif command -v yum >/dev/null 2>&1; then
          sudo yum update -y zsh
        elif command -v pacman >/dev/null 2>&1; then
          sudo pacman -Syu --noconfirm zsh
        else
          echo "‚ùå Unsupported package manager"
          exit 1
        fi
      - task: :messaging:success
        vars:
          MESSAGE: "zsh updated successfully"

  update:darwin:
    internal: true
    platforms: [darwin]
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          brew upgrade zsh
        else
          echo "‚ùå Homebrew not found"
          exit 1
        fi
      - task: :messaging:success
        vars:
          MESSAGE: "zsh updated successfully"
