version: '3'

vars:
  gum_info:
    sh: |
      if command -v gum >/dev/null 2>&1; then
        echo "gum style --foreground 240"
      else
        echo "echo"
      fi
  gum_warn:
    sh: |
      if command -v gum >/dev/null 2>&1; then
        echo "gum style --foreground 208 --bold"
      else
        echo "echo"
      fi
  gum_error:
    sh: |
      if command -v gum >/dev/null 2>&1; then
        echo "gum style --foreground 196 --bold"
      else
        echo "echo"
      fi
  gum_ok:
    sh: |
      if command -v gum >/dev/null 2>&1; then
        echo "gum style --foreground 46 --bold"
      else
        echo "echo"
      fi

tasks:
  cursor:rules:
    silent: true
    deps: [ ":tools:gum:install" ]
    desc: "[CURSOR] Install Cursor rules to current repository"
    vars:
      RULES_DIR: $HOME/.omt/dotfiles/cursor-rules
    cmds:
      - |
        if [ ! -d "{{ .RULES_DIR }}" ]; then
          {{ .gum_error }} "❌ Cursor rules directory not found: {{ .RULES_DIR }}"
          return 1
        fi
      - |
        if [ ! -f "{{ .RULES_DIR }}/*" ]; then
          {{ .gum_error }} "❌ No files found in {{ .RULES_DIR }}"
          return 1
        fi
      - |
        echo "Installing Cursor rules to current directory..."
        {{ .gum_info }} "[info] Creating .cursorrules directory..."
        mkdir -p .cursorrules
        for file in {{ .RULES_DIR }}/*; do
          if [ ! -f ".cursorrules/$(basename $file)" ]; then
            cp -r $file .cursorrules
          else

            if [[ "$ALWAYS_OVERWRITE" == "true" ]]; then
                cp -r $file .cursorrules
                continue
            fi
            
            if [[ "$OPERATION_CANCELLED" == "true" ]]; then
                return 1
            fi
            
            # Styled warning message
            {{ .gum_warn }} "⚠️  File already exists: $file"
            
            # Choice with custom styling
            CHOICE=$(gum choose \
                --header "$(gum style --foreground 212 --bold --background 235 'Choose an action:')" \
                --cursor.foreground 212 \
                --selected.foreground 212 \
                --selected.bold \
                "yes - overwrite this file" \
                "always - overwrite all remaining files" \
                "no - skip this file" \
                "cancel - abort entire operation")
            
            case "$CHOICE" in
                "yes - overwrite this file")
                    return 0
                    ;;
                "always - overwrite all remaining files")
                    ALWAYS_OVERWRITE=true
                    {{ .gum_ok }} "✓ Will overwrite all remaining files"
                    return 0
                    ;;
                "no - skip this file")
                    return 1
                    ;;
                "cancel - abort entire operation")
                    {{ .gum_error }} "❌ Operation cancelled"
                    return 1
                    ;;
            esac
          fi
        done
        {{ .gum_ok }} "✓ Cursor rules installed successfully."
