version: "3"

includes:
  github:
    taskfile: ../lib/github.yaml
    flatten: true
    vars:
      HELP_PREFIX: "[CRUSH] ✨  "
      REPO: charmbracelet/crush
      SEARCH_LINUX: 'Linux_x86_64.tar.gz'
      SEARCH_DARWIN: 'Darwin_x86_64.tar.gz'
      SEARCH_WINDOWS: 'Windows_x86_64.zip'
      BINARY_LINUX: '**/crush'
      BINARY_DARWIN: '**/crush'
      BINARY_WINDOWS: '**/crush.exe'
      BINARY_PATH: '$HOME/bin'

tasks:
  default:
    - task --list --taskfile apps/crush.yaml

  configure:
    desc: "[CRUSH] ⚙️  Configure Crush"
    vars:
      CONFIG_FILE: 'crush.json'
      CONFIG_SOURCE_PATH: 'dotfiles/crush'
      CONFIG_DEST_PATH: '$HOME/.config/crush'
      CONFIG_SOURCE_FILE: '{{ osClean (list .CONFIG_SOURCE_PATH .CONFIG_FILE | join "/")}}'
      CONFIG_DEST_FILE: '{{ osClean (list .CONFIG_DEST_PATH .CONFIG_FILE | join "/")}}'
    cmds:
      - |
        if [ ! -d "{{ .CONFIG_DEST_PATH }}" ]; then
          mkdir -p "{{ .CONFIG_DEST_PATH }}"
        fi
        {{ if .UNATTENDED }}
        {{ .gum_info }} "Unattended mode enabled, skipping interactive configuration."
        if [ ! -f "{{ .CONFIG_DEST_FILE }}" ]; then
          cp "{{ .CONFIG_SOURCE_FILE }}" "{{ .CONFIG_DEST_FILE }}"
          {{ .gum_ok }} "Configuration saved successfully."
        else
          {{ .gum_warn }} "Configuration already exist, skipping configuration."
        fi
        {{ else }}
        if [ -f "{{ .CONFIG_DEST_FILE }}" ]; then
          if ! gum confirm "Configuration already exist, overwrite?"; then
            {{ .gum_warn }} "Configuration already exist, skipping configuration."
            exit 0
          fi
        fi
        if gum confirm "Do you want to configure Crush to use Microsoft Foundry?"; then
          FOUNDRY_RESOURCE_NAME=$(gum input --placeholder "Enter your Microsoft Foundry Resource Name" --header "Microsoft Foundry Resource Name")
          export FOUNDRY_RESOURCE_NAME="$FOUNDRY_RESOURCE_NAME"
          gomplate -f "{{ .CONFIG_SOURCE_FILE }}.tmpl" -o "{{ .CONFIG_DEST_FILE }}"
          {{ .gum_info }} " Remember to set environment variable AZURE_OPENAI_API_KEY to your api key!"
        else
          cp "{{ .CONFIG_SOURCE_FILE }}" "{{ .CONFIG_DEST_FILE }}"
        fi
        {{ .gum_ok }} "Configuration saved successfully."
        {{ end }}

  slash-commands:
    desc: "[CRUSH] Configure Crush slash commands"
    vars:
      SLASH_COMMANDS_SOURCE_DIR: "dotfiles/crush/prompts"
      SLASH_COMMANDS_DEST_DIR: "$HOME/.crush/skills"
    dir: "{{ .SLASH_COMMANDS_SOURCE_DIR }}"
    sources:
      - "*.md"
    method: none
    cmds:
      - |
        if [ ! -d "{{ .SLASH_COMMANDS_DEST_DIR }}" ]; then
          mkdir -p "{{ .SLASH_COMMANDS_DEST_DIR }}"
        fi
      - for: sources
        cmd: |
          cp "{{joinPath .ITEM | osClean}}" "{{joinPath .SLASH_COMMANDS_DEST_DIR .ITEM | osDir}}"
